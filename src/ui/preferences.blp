// Copyright (C) 2022 - 2023 Alessandro Iepure
//
// SPDX-License-Identifier: GPL-3.0-or-later

using Gtk 4.0;
using Adw 1;

template $PreferencesDialog: Adw.PreferencesDialog {
  search-enabled: false;

  map => $_on_map();

  Adw.PreferencesPage {
    name: "preferences";
    title: _("Preferences");

    Adw.PreferencesGroup _download_group {
      title: C_("preferences", "Optional Download");
      description: C_("preferences", "For a complete experience, a download of 15 KB is required. The initial setup could not retrieve the data automatically and thus offline mode has been activated. It will remain active until the setup is completed.");

      Adw.ActionRow _download_row {
        // TRANSLATORS: When clicked, it completes the initial setup by downloading the optional data.
        title: C_("preferences", "Complete Setup");
        activated => $_on_download_activate();
        activatable: true;

        Image {
          icon-name: "right";
        }
      }
    }

    Adw.PreferencesGroup _offline_group {
      title: C_("preferences", "Offline Mode");
      description: C_("preferences", "Ticket Booth can work entirely offline. If you choose to run in this mode, some features that require the Internet and/or access to third party APIs will not be available.");

      Adw.SwitchRow _offline_switch {
        title: C_("preferences", "Enable Offline Mode");
      }
    }

    Adw.PreferencesGroup _tmdb_group {
      title: C_("preferences", "The Movie Database (TMDB)");
      description: C_("preferences", "TMDB provides localized metadata for most content. Ticket Booth will download content in your preferred language, selectable below. In the event that the content is not available in your preferred language, TMDB will default to English (US) and then to the content's original language. If neither are available the result will be a blank string. Please consider <a href='https://www.themoviedb.org/bible/new_content'>contributing to TMDB</a>. \nAdditionally, an automatic update is performed on a frequency of your choosing. \nWe also support syncing with your TMDB accounts watchlist. To use this feature you will need an account on TMDB. You can create one <a href='https://www.themoviedb.org/signup'>here</a>.");

      Adw.ComboRow _language_comborow {
        title: C_("preferences", "TMDB Results Language");
        model: StringList _language_model {};
      }

      Adw.ComboRow _update_freq_comborow {
        title: C_("preferences", "Update Frequency");
        subtitle: C_("preferences", "Restart Ticket Booth after changing");
        model: StringList {
          strings[
            C_("preferences", "Never"),
            C_("preferences", "Daily"),
            C_("preferences", "Weekly"),
            C_("preferences", "Monthly")
          ]
        };
      }

      Adw.SwitchRow _use_own_key_switch {
        title: C_("preferences", "Use Your API Key");
        subtitle: C_("preferences", "Register yours <a href='https://www.themoviedb.org/settings/api'>here</a>");
      }

      Adw.EntryRow _own_key_entryrow {
        title: C_("preferences", "Your API key");
        visible: bind _use_own_key_switch.active;

        [suffix]
        Button _check_own_key_button {
          label: C_("preferences", "Save Key");
          valign: center;

          clicked => $_on_check_own_key_button_clicked();
        }

        changed => $_on_own_key_changed();
      }
      Adw.ActionRow _tmdb_sync_row {
        title: _("TMDB sync settings");
        activatable: true;
        activated => $_tmdb_sync_row_activated();
        [suffix]
        Gtk.Image {
          icon-name: "go-next-symbolic";
          styles ["dim-label"]
        }
      }
    }

    Adw.PreferencesGroup _housekeeping_group {
      title: C_("preferences", "Housekeeping");

      Adw.PreferencesGroup {
        Adw.SwitchRow _exit_cache_switch {
          title: C_("preferences", "Clear Cache on Exit");
        }

        Adw.ActionRow _cache_row {
          title: C_("preferences", "Clear Cached Search Data");
          activated => $_on_clear_cache_activate();
          activatable: true;

          Image {
            icon-name: "right";
          }
        }

        Adw.ActionRow _data_row {
          title: C_("preferences", "Clear Data");
          activated => $_on_clear_activate();
          activatable: true;

          Image {
            icon-name: "right";
          }
        }
      }
    }   
  }
}

Adw.PreferencesPage _tmdb_setup_page {
  map => $_tmdb_sync_map();

  Box { 
    orientation: vertical;
    vexpand: true;
    hexpand: true;
    valign: center;
    halign: center;

    Adw.Carousel _tmdb_carousel {
      vexpand: true;
      hexpand: true;
      allow-scroll-wheel: false;
      allow-mouse-drag: false;
      allow-long-swipes: false;

      Adw.StatusPage _first_tmdb_page {
        vexpand: true;
        hexpand: true;
        title: _("Access TMDB Account");
        description: _("To sync your watchlist between Ticketbooth and TMDB you will need to give us access to your Account. We will only access your watchlist and nothing else. \n Please follow the instructions in the link that will open once you click the button below.");
        
        Box {
          width-request: 30;
          halign: center;
          valign: center;
          margin-top: 24;
          Gtk.Button _tmdb_session_ID_btn {
            width-request: 50;
            label: _("Open TMDB");
            styles  ["suggested-action"]
            clicked => $_tmdb_link_clicked();
          }
        }
        
      }
    

      
    Adw.StatusPage _second_tmdb_page {

      vexpand: true;
      hexpand: true;
      title: _("Decide how to Sync");
      description: _("Please decide if you want to delete the local watchlist or if you want to merge your local and TMDB watchlist. \n Be careful, the first option will <b>delete</b> your local watchlist and is <b>irreversible</b>.");

      Box {
        orientation: vertical;
        valign: center;
        halign: center;

        Overlay {
          [overlay]
          Spinner _tmdb_spinner{
            spinning: true;
            visible: false;
            height-request: 48;
          }
          Box _tmdb_radio_button_box{
            orientation: vertical;
            Gtk.CheckButton _keep_tmdb_check_btn {
              label: _("Keep TMDB watchlist");
              margin-bottom: 12;
              active: false;
            }
            Gtk.CheckButton _keep_both_check_btn {
              label: _("Merge both watchlists");
              margin-bottom: 12;
              active: true;
              group: _keep_tmdb_check_btn;
            }
          }
        }
      }
    } 
      

      Adw.StatusPage _last_tmdb_page {
        vexpand: true;
        hexpand: true;
        title: _("TMDB Sync is activated");
        description: _("Use the button below to logout of your TMDB Account. This will revoke Ticketbooths access to your account and will stop the sync.");

        Box {
          width-request: 35;
          margin-top: 24;
          halign: center;
          Gtk.Button _tmdb_session_ID_logout_btn {
            label: _("Logout from TMDB");
            styles  ["destructive-action"]
            clicked => $_tmdb_logout_clicked();
          }
        }
      }
    }
  
    Box {
      orientation: horizontal;
      width-request: 400;
      hexpand: true;
      vexpand: true;
      halign: center;
      valign: center;
      Box{
        hexpand: true;
        halign: start;
        margin-start: 30;
        Gtk.Button _tmdb_close_btn {
          visible: true;
          label: _("Go back");
          styles ["suggested-action", "pill"]
          clicked => $_on_tmdb_close_btn_clicked();
        }
      }
      
    
      Box{
        hexpand: true;
        halign: end;
        margin-end: 30;
        Gtk.Button _tmdb_continue_btn {
          label: _("Continue");
          visible: true;
          sensitive: false;
          styles ["suggested-action", "pill"]
          clicked => $_on_tmdb_continue_btn_clicked();
        }
      }      
    }
  }
}
